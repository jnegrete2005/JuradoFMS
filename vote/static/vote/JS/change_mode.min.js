async function saveMode(e){function t(e){const t=e=>e>=0&&e<=4&&e%.5==0;return t(parseFloat(e.value))?parseFloat(e.value):9}let o=Competitor.unserialize(localStorage.getItem("comp_1")),a=Competitor.unserialize(localStorage.getItem("comp_2"));const r=Array.from(document.getElementsByClassName("comp-1-input")).map(t),n=Array.from(document.getElementsByClassName("comp-2-input")).map(t);if(e.startsWith("min")){const t=e=>e.checked?1:9;"1"===e.charAt(e.length-1)?(r.push(...Array.from(document.getElementsByClassName("check-1")).map(t)),r.push(9,9,9),n.push(...new Array(9).fill(9))):(n.push(...Array.from(document.getElementsByClassName("check-2")).map(t)),n.push(9,9,9),r.push(...new Array(9).fill(9)))}try{validateLength(r,n,e)}catch(e){return createError(e),!1}const s=e=>e.every(e=>9===e);if(s(r),s(n))return o[e]=r,a[e]=n,localStorage.setItem("comp_1",o.serialize()),localStorage.setItem("comp_2",a.serialize()),!0;if(o[e]&&a[e]&&arraysMatch(o[e],r)&&arraysMatch(a[e],n))return!0;const d="\n    mutation SaveModes($id: ID!, $mode: String!, $value1: [Float]!, $value2: [Float]!) {\n      saveModes(pollId: $id, mode: $mode, value1: $value1, value2: $value2) {\n        comp1 {\n          mode\n        }\n        comp2 {\n          mode\n        }\n      }\n    }\n  ",c=await fetch("/graphql/",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRFToken":getCookie("csrftoken")},body:JSON.stringify({query:d,variables:{id:parseInt(localStorage.getItem("poll")),mode:e,value1:r,value2:n}})}).then(e=>{if(!e.ok)throw Error(`${e.statusText} - ${e.status}`);return e.json()}).then(t=>{if(t.errors)throw Error(t.errors[0].message);return o[e]=t.data.saveModes.comp1.mode,a[e]=t.data.saveModes.comp2.mode,localStorage.setItem("comp_1",o.serialize()),localStorage.setItem("comp_2",a.serialize()),!0}).catch(e=>(createError(e),!1));return c}function nextMode(e){function t(t){document.getElementById("mode").dataset.current_mode=e,document.getElementById("mode").innerHTML=modes_aliases[e],null!==t.data.comp1.mode?e.startsWith("min")?addInputs(9,t):addInputs(t.data.comp1.mode.length,t):addInputs(mode_length[e]),createAlert("Recuerda que los últimos 3 cuadritos siempre son para Skills, Flow y Puesta en escena")}const o=Competitor.unserialize(localStorage.getItem("comp_1"))[e],a=Competitor.unserialize(localStorage.getItem("comp_2"))[e];if("true"===getCookie("isActive")){let r;return r=o&&a?{data:{comp1:{mode:o},comp2:{mode:a}}}:{data:{comp1:{mode:new Array(mode_length[e]).fill(9)},comp2:{mode:new Array(mode_length[e]).fill(9)}}},void t(r)}setCookie("isActive","true",.3);const r="\n    query GetModes($id1: ID!, $id2: ID!, $mode: String!) {\n      comp1: getMode(id: $id1, mode: $mode) {\n        mode\n      }\n      comp2: getMode(id: $id2, mode: $mode) {\n        mode\n      }\n    }\n  ";fetch("/graphql/",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRFToken":getCookie("csrftoken")},body:JSON.stringify({query:r,variables:{id1:JSON.parse(localStorage.getItem("comp_1")).id,id2:JSON.parse(localStorage.getItem("comp_2")).id,mode:e}}),credentials:"include"}).then(e=>{if(!e.ok)throw Error(`${e.statusText} - ${e.status}`);return e.json()}).then(e=>{if(e.errors)throw Error(e.errors[0].message);t(e)}).catch(e=>{createError(e)})}function prepareBtns(e){const t=document.getElementById("previous"),o=document.getElementById("next");switch(e){case"easy":t.disabled=!0,t.classList.add("disabled"),o.value="Siguiente";break;case"deluxe":case"replica":o.value="Terminar",t.disabled=!1,t.classList.remove("disabled");break;default:t.disabled=!1,t.classList.remove("disabled"),o.value="Siguiente"}}function showSections(e=!1){document.getElementById("end-container").classList.toggle("d-none",!e),document.getElementById("poll-container").classList.toggle("d-none",e),document.getElementById("rep-res-container").classList.add("d-none")}function appendEndScripts(e=!1){const t=document.createElement("script");t.src=e?"/static/vote/JS/replica.js":"/static/vote/JS/end.js",t.type="module",document.querySelector("body").appendChild(t)}function validateLength(e,t,o){switch(o){case"deluxe":if(14!==e.length||14!==t.length)throw new Error("Deluxe no puede tener ni más ni menos de 14 elementos");break;case"tematicas_1":case"tematicas_2":if(7!==e.length||7!==t.length)throw new Error("Tematicas no puede tener más ni menos de 7 elementos");break;case"min1":case"min2":if(18!==e.length||18!==t.length)throw new Error("Los minutos tienen que tener 18 elementos (los checks cuentan)");break;case"random_score":if(11!==e.length||11!==t.length)throw new Error("Random mode no puede tener más ni menos de 11 elementos");break;default:if(9!==e.length||9!==t.length)throw new Error(`${modes_aliases[o]} no puede tener más ni menos de 9 elementos`)}}import{prepareNavbar}from"./navbar.js";import{modes_aliases,Competitor,mode_length}from"./classes.js";import{addInputs,arraysMatch,createAlert,createError,getCookie,setCookie}from"./util.js";export async function changeMode(e,t){function o(e=!1){nextMode(t),prepareBtns(t),prepareNavbar(t,e),showSections()}if("end"===e||"end_replica"===e)return"end"===t?(document.getElementById("mode").dataset.current_mode=t,prepareNavbar(t),void showSections(!0)):void o();if(await saveMode(e))switch(t){case"end":document.getElementById("mode").dataset.current_mode=t,prepareNavbar(t),showSections(!0),document.querySelector("body > script[src='/static/vote/JS/end.js']")||appendEndScripts();break;case"end_replica":if("replica"!==e)throw Error("Esta sección solo puede ser accedida después de Réplica.");document.getElementById("mode").dataset.current_mode=t,prepareNavbar("end"),document.querySelector("body > script[src='/static/vote/JS/replica.js']")||appendEndScripts(!0);break;case"replica":o(!0);break;default:return void o()}}